package com.bnpparibas.atlentic.iacc.bopr.level.test;

import static org.mockito.Mockito.*;
import static org.junit.Assert.*;

import java.lang.reflect.Method;
import java.lang.reflect.Field;
import java.sql.Connection;
import java.sql.SQLException;
import java.io.IOException;
import java.util.Collections;

import org.junit.Test;
import org.junit.Before;
import org.junit.After;
import org.mockito.MockedStatic;
import org.mockito.Mockito;

import com.bnpparibas.atlentic.common.GlobalAtlentic;
import com.bnpparibas.atlentic.common.utils.DBUtils;
import com.bnpparibas.atlentic.iacc.bopr.level.P06_IACC_01_Level;
import com.bnpparibas.atlentic.iacc.bopr.exception.P06_IACC_01_ExitApplicationException;
import com.bnpparibas.atlentic.iacc.bopr.exception.P06_IACC_01_SQLException;
import com.bnpparibas.atlentic.iacc.bopr.bean.P06_IACC_01_BoprRecordBean;
import com.bnpparibas.atlentic.iacc.bopr.level.P06_IACC_01_DBTransaction;

public class P06_IACC_01_Level_ExecuteTest {

    private P06_IACC_01_Level levelInstance;
    private Connection mockConnection;
    private P06_IACC_01_DBTransaction mockDBTransaction;

    private MockedStatic<GlobalAtlentic> globalAtlenticMock;
    private MockedStatic<DBUtils> dbUtilsMock;

    @Before
    public void setUp() throws Exception {
        // Use anonymous subclass if P06_IACC_01_Level is abstract
        levelInstance = new P06_IACC_01_Level() {
            @Override
            protected int getLevelNumber() {
                return 1;
            }

            @Override
            protected void innerExecute() throws IOException, P06_IACC_01_SQLException {
                // Simulate valid behavior
            }

            @Override
            protected boolean applyCommit() {
                return true;
            }
        };

        mockConnection = mock(Connection.class);
        mockDBTransaction = mock(P06_IACC_01_DBTransaction.class);

        // Set g_o_dataBaseTransaction using reflection
        Field dbTransField = P06_IACC_01_Level.class.getDeclaredField("g_o_dataBaseTransaction");
        dbTransField.setAccessible(true);
        dbTransField.set(levelInstance, mockDBTransaction);

        // Mock GlobalAtlentic.getLoanIQConnection()
        globalAtlenticMock = Mockito.mockStatic(GlobalAtlentic.class);
        globalAtlenticMock.when(GlobalAtlentic::getLoanIQConnection).thenReturn(mockConnection);

        // Mock DBUtils.closeConnexion()
        dbUtilsMock = Mockito.mockStatic(DBUtils.class);

        // Stub initializeDataBaseTransaction method (if private)
        Method initMethod = P06_IACC_01_Level.class.getDeclaredMethod("initializeDataBaseTransaction", Connection.class);
        initMethod.setAccessible(true);
        initMethod.invoke(levelInstance, mockConnection);

        // Stub getRecordsBeansList()
        when(mockDBTransaction.getRecordsBeansList()).thenReturn(Collections.singletonList(new P06_IACC_01_BoprRecordBean()));
    }

    @After
    public void tearDown() {
        globalAtlenticMock.close();
        dbUtilsMock.close();
    }

    @Test
    public void testExecute_SuccessfulExecution() throws Exception {
        Method executeMethod = P06_IACC_01_Level.class.getDeclaredMethod("execute");
        executeMethod.setAccessible(true);

        executeMethod.invoke(levelInstance);

        verify(mockConnection).setAutoCommit(false);
        verify(mockConnection).commit();
        dbUtilsMock.verify(() -> DBUtils.closeConnexion(mockConnection, null, null), times(1));
    }

    @Test(expected = P06_IACC_01_ExitApplicationException.class)
    public void testExecute_IOException_TriggersRollback() throws Throwable {
        // Override innerExecute to throw IOException
        P06_IACC_01_Level errorLevelInstance = new P06_IACC_01_Level() {
            @Override
            protected int getLevelNumber() {
                return 1;
            }

            @Override
            protected void innerExecute() throws IOException {
                throw new IOException("Test IO Error");
            }

            @Override
            protected boolean applyCommit() {
                return true;
            }
        };

        // Inject mock DBTransaction
        Field dbTransField = P06_IACC_01_Level.class.getDeclaredField("g_o_dataBaseTransaction");
        dbTransField.setAccessible(true);
        dbTransField.set(errorLevelInstance, mockDBTransaction);

        // Mock again
        globalAtlenticMock.when(GlobalAtlentic::getLoanIQConnection).thenReturn(mockConnection);

        // init DB transaction via reflection
        Method initMethod = P06_IACC_01_Level.class.getDeclaredMethod("initializeDataBaseTransaction", Connection.class);
        initMethod.setAccessible(true);
        initMethod.invoke(errorLevelInstance, mockConnection);

        when(mockDBTransaction.getRecordsBeansList()).thenReturn(Collections.singletonList(new P06_IACC_01_BoprRecordBean()));

        // Call and assert exception using reflection
        Method executeMethod = P06_IACC_01_Level.class.getDeclaredMethod("execute");
        executeMethod.setAccessible(true);
        try {
            executeMethod.invoke(errorLevelInstance);
        } catch (Exception e) {
            throw e.getCause(); // Unwrap InvocationTargetException
        }
    }
}
